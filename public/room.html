<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/shared-styles.css">
</head>
<body>
    <div class="snow" id="snow"></div>
    
    <div class="content min-h-screen flex items-center justify-center p-4">
        <div class="christmas-card p-8 max-w-4xl w-full">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="christmas-font text-5xl text-red-700 mb-2" data-i18n="room.header.title">ğŸ… Secret Santa ğŸ„</h1>
                <h2 id="roomNameDisplay" class="text-2xl text-gray-700 font-bold"></h2>
            </div>
            <!-- Room Info (visible to everyone) -->
            <div id="roomInfoCard" class="bg-white border-2 border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="font-bold text-gray-800 mb-2" data-i18n="room.info.sectionTitle">â„¹ï¸ Room Info</h3>
                <div class="text-gray-700">
                    <p><strong data-i18n="room.info.budget">Budget</strong>: <span id="infoBudget"></span></p>
                    <p class="mt-1"><strong data-i18n="room.info.instructions">Instructions</strong>:</p>
                    <div id="infoInstructions" class="whitespace-pre-wrap"></div>
                </div>
            </div>
            
            <!-- Registration View -->
            <div id="registerView" class="hidden">
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
                    <h3 class="font-bold text-blue-800 mb-2" data-i18n="room.registration.introTitle">ğŸ Join or Access the Secret Santa!</h3>
                    <p class="text-gray-700" data-i18n-html="room.registration.introText">
                        <strong>New participant?</strong> Create your account below to join.<br>
                        <strong>Already registered?</strong> Enter your credentials to access the room.
                    </p>
                </div>
                
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2" data-i18n="room.registration.username">Username</label>
                        <input type="text" id="regUsername" required class="input-christmas" placeholder="Your name">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2" data-i18n="room.registration.password">Password</label>
                        <input type="password" id="regPassword" required minlength="4" class="input-christmas" placeholder="Your password">
                        <p class="text-xs text-gray-600 mt-1" data-i18n="room.registration.password.help">âš ï¸ New users: Choose a password you'll remember. Existing users: Enter your password.</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2" data-i18n="room.preferences.sectionTitle">ğŸ¯ Gift Preferences</label>
                        <textarea id="regPreferences" class="input-christmas" rows="3" data-i18n-placeholder="room.preferences.textarea.placeholder" placeholder="Likes, dislikes, allergies, ideas..."></textarea>
                        <p id="regPrefsSaved" class="hidden text-green-700 text-sm mt-1" data-i18n="room.preferences.saved">âœ… Preferences saved</p>
                    </div>
                    <button type="submit" class="btn-christmas w-full" data-i18n="shared.btn.registerJoin">âœ¨ Continue</button>
                </form>
                
                <div id="registerSuccess" class="hidden mt-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                    <h4 class="font-bold text-green-800 mb-2" data-i18n="room.registration.successTitle">âœ… Registration Successful!</h4>
                    <p class="text-green-700" data-i18n="room.registration.successText">Wait for the host to start the room, then sign in to see your assignment!</p>
                </div>
            </div>
            
            <!-- Host Management View -->
            <div id="hostView" class="hidden">
                <!-- Host Auth Form -->
                <div id="hostAuthForm" class="mb-6">
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                        <h3 class="font-bold text-yellow-800 mb-2" data-i18n="room.hostAuth.title">ğŸ”‘ Host Sign In</h3>
                        <p class="text-gray-700" data-i18n="room.hostAuth.text">Sign in to manage this room.</p>
                    </div>
                    
                    <form id="hostLoginForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-2" data-i18n="room.hostAuth.username">Username</label>
                            <input type="text" id="hostUsername" required class="input-christmas" placeholder="Your username">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-2" data-i18n="room.hostAuth.password">Password</label>
                            <input type="password" id="hostPassword" required class="input-christmas" placeholder="Your password">
                        </div>
                        <button type="submit" class="btn-christmas w-full" data-i18n="shared.btn.signInHost">ğŸ”“ Sign In as Host</button>
                    </form>
                </div>
                
                <!-- Host Management Panel -->
                <div id="hostManagement" class="hidden space-y-6">
                    <!-- Share Room Link -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
                        <h3 class="font-bold text-blue-800 mb-3" data-i18n="index.success.title">ğŸ‰ Room Created!</h3>
                        <p class="text-gray-700 mb-3" data-i18n="index.success.share">Share this link with your participants:</p>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="roomInviteUrl" readonly class="input-christmas flex-1 text-sm">
                            <button type="button" class="btn-christmas" id="copyInviteBtn" data-i18n="shared.btn.copyLink" onclick="copyInviteLink()">ğŸ“‹ Copy Link</button>
                        </div>
                    </div>
                    <!-- Pairing Blacklist (Host only) -->
                    <div id="blacklistPanel" class="bg-white border-2 border-gray-200 rounded-lg p-6">
                        <h3 class="font-bold text-gray-800 mb-2" data-i18n="blacklist.sectionTitle">ğŸš« Pairing Blacklist</h3>
                        <p id="blacklistHelp" class="text-xs text-gray-600 mb-3" data-i18n="blacklist.help">Enter usernames to avoid specific pairings (case-insensitive).</p>
                        <div id="blacklistContainer" class="space-y-2"></div>
                        <div id="blacklistActions" class="flex gap-2 mt-2">
                            <button type="button" class="btn-christmas" onclick="addBlacklistRow()" data-i18n="blacklist.addRule">â• Add Rule</button>
                            <button type="button" class="btn-christmas" onclick="saveBlacklist()" data-i18n="blacklist.save">ğŸ’¾ Save Blacklist</button>
                            <span id="blacklistSaved" class="hidden text-green-700 self-center" data-i18n="blacklist.saved">âœ… Blacklist saved</span>
                        </div>
                    </div>
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6">
                        <h3 class="font-bold text-green-800 mb-4"><span data-i18n="room.participants.title">ğŸ‘¥ Participants</span> (<span id="participantCount">0</span>)</h3>
                        <div id="participantList" class="space-y-2"></div>
                        <button onclick="refreshParticipants()" type="button" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" data-i18n="room.refreshList">ğŸ”„ Refresh List</button>
                    </div>
                    
                    <div id="startRoomSection" class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6">
                        <h3 class="font-bold text-yellow-800 mb-2" data-i18n="room.start.readyTitle">ğŸš€ Ready to Start?</h3>
                        <p class="text-gray-700 mb-4" data-i18n="room.start.desc">Once started, assignments are generated and no changes allowed.</p>
                        <button onclick="startRoom()" type="button" class="btn-christmas w-full" data-i18n="shared.btn.startSecretSanta">ğŸ Start Secret Santa</button>
                    </div>
                    
                    <div id="roomStartedMessage" class="hidden bg-green-50 border-2 border-green-300 rounded-lg p-6">
                        <h3 class="font-bold text-green-800 mb-2" data-i18n="room.roomStarted.title">âœ… Room Started!</h3>
                        <p class="text-gray-700" data-i18n="room.roomStarted.desc">Participants can now sign in to view their assignments.</p>
                    </div>
                </div>
            </div>
            
            <!-- Login View -->
            <div id="loginView" class="hidden">
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
                    <h3 class="font-bold text-blue-800 mb-2" data-i18n="room.login.title">ğŸ” Sign In</h3>
                    <p class="text-gray-700" data-i18n="room.login.desc">The room has started! Sign in to see your Secret Santa assignment.</p>
                </div>
                
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2" data-i18n="room.registration.username">Username</label>
                        <input type="text" id="loginUsername" required class="input-christmas" placeholder="Your username">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2" data-i18n="room.registration.password">Password</label>
                        <input type="password" id="loginPassword" required class="input-christmas" placeholder="Your password">
                    </div>
                    <button type="submit" class="btn-christmas w-full" data-i18n="shared.btn.viewAssignment">ğŸ View My Assignment</button>
                </form>
            </div>
            
            <!-- Assignment Reveal View -->
            <div id="assignmentView" class="hidden">
                <div class="bg-gradient-to-r from-yellow-50 to-green-50 border-3 border-red-400 rounded-xl p-8 reveal-animation">
                    <h3 class="christmas-font text-4xl text-red-800 mb-4 text-center" data-i18n="shared.assignments.title">ğŸ… Your Assignment ğŸ„</h3>
                    <div class="text-xl font-bold text-gray-800 mb-2 text-center" id="assignmentSubtitle">
                        <span id="loggedInUsername"></span>, you are buying a gift for:
                    </div>
                    <div id="assignedPerson" class="christmas-font text-6xl text-red-700 mb-6 text-center"></div>
                    <div class="bg-white border border-gray-300 rounded-lg p-4 mt-4">
                        <h4 class="font-bold text-gray-800 mb-2" data-i18n="room.preferences.recipientTitle">ğŸ Your recipientâ€™s preferences</h4>
                        <div id="recipientPreferences" class="text-gray-700 whitespace-pre-wrap"></div>
                    </div>
                    <div class="text-gray-700 text-center space-y-2">
                        <p data-i18n="shared.assignments.keepSecret">ğŸ¤« Keep it a secret!</p>
                        <p data-i18n="shared.assignments.makeSpecial">ğŸ Make it special!</p>
                        <p data-i18n="shared.assignments.spreadJoy">â„ï¸ Spread the joy!</p>
                    </div>
                </div>
            </div>
            
            <!-- Error View -->
            <div id="errorView" class="hidden">
                <div class="bg-red-100 border-2 border-red-400 p-6 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-red-800 mb-2" data-i18n="room.error.title">âŒ Error</h3>
                    <p id="errorMessage" class="text-red-600"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
    <script src="/shared-utils.js"></script>
    
    <script>
        // State
        const roomId = window.location.pathname.split('/').pop();
        let currentRoom = null;
        let currentHostUsername = null;
        let currentHostPassword = null;
        
        // View Management
        function showView(viewId) {
            ['registerView', 'hostView', 'loginView', 'assignmentView', 'errorView']
                .forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showView('errorView');
        }
        
        // Load Room
        async function loadRoom() {
            try {
                const response = await fetch(`/api/rooms/${roomId}`);
                const room = await response.json();
                
                if (!response.ok) {
                    showError(room.error || 'Room not found');
                    return;
                }
                
                currentRoom = room;
                document.getElementById('roomNameDisplay').textContent = room.name;
                populateRoomInfo(room);
                
                // Try stored host credentials
                const storedUser = sessionStorage.getItem(`hostUser_${roomId}`);
                const storedPass = sessionStorage.getItem(`hostPass_${roomId}`);
                
                if (storedUser && storedPass) {
                    const authResponse = await fetch(`/api/rooms/${roomId}/host-auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: storedUser, password: storedPass })
                    });
                    
                    if (authResponse.ok) {
                        const data = await authResponse.json();
                        currentHostUsername = storedUser;
                        currentHostPassword = storedPass;
                        currentRoom = data;
                        showHostManagementView(data);
                        return;
                    }
                }
                
                // Show appropriate view
                showView(room.status === 'started' ? 'loginView' : 'registerView');
            } catch (error) {
                showError('Error loading room: ' + error.message);
            }
        }
        
        // Host Management View
        function showHostManagementView(data) {
            showView('hostView');
            document.getElementById('hostAuthForm').classList.add('hidden');
            document.getElementById('hostManagement').classList.remove('hidden');
            displayParticipants(data.participants, true);
            populateInviteLink();
            populateRoomInfo(data);
            renderBlacklist(data.blacklist || [], data.participants || [], false);
            const bl = document.getElementById('blacklistPanel');
            if (bl) bl.classList.remove('hidden');
            setBlacklistReadOnly(false);
            
            if (data.status === 'started') {
                document.getElementById('startRoomSection').classList.add('hidden');
                document.getElementById('roomStartedMessage').classList.remove('hidden');
            }
        }
        
        // Participant View (non-host)
        function showParticipantView(roomData) {
            showView('hostView');
            document.getElementById('hostAuthForm').classList.add('hidden');
            document.getElementById('hostManagement').classList.remove('hidden');
            displayParticipants(roomData.participants, false);
            populateInviteLink();
            populateRoomInfo(roomData);
            
            // Hide management controls for non-host
            document.getElementById('startRoomSection').classList.add('hidden');
            (async () => {
                try {
                    if (Array.isArray(roomData.blacklist)) {
                        renderBlacklist(roomData.blacklist, roomData.participants || [], true);
                    } else {
                        const pub = await fetch(`/api/rooms/${roomId}`).then(r => r.ok ? r.json() : { blacklist: [] });
                        renderBlacklist(pub.blacklist || [], roomData.participants || [], true);
                    }
                } catch {
                    renderBlacklist([], roomData.participants || [], true);
                }
                setBlacklistReadOnly(true);
            })();
            
            if (roomData.status === 'started') {
                document.getElementById('roomStartedMessage').innerHTML = `<h3 class=\"font-bold text-green-800 mb-2\">${t('room.startedHostMsg')}</h3><p class=\"text-gray-700\">${t('room.startedParticipantDesc')}</p><button onclick=\"location.reload()\" class=\"btn-christmas w-full mt-4\">${t('btn.viewAssignment')}</button>`;
                document.getElementById('roomStartedMessage').classList.remove('hidden');
            } else {
                document.getElementById('roomStartedMessage').innerHTML = `<h3 class=\"font-bold text-blue-800 mb-2\">${t('room.waitingHostTitle')}</h3><p class=\"text-gray-700\">${t('room.waitingHostDesc')}</p>`;
                document.getElementById('roomStartedMessage').classList.remove('hidden');
            }
        }
        
        // Display Participants
        function displayParticipants(participants, isHost = true) {
            const list = document.getElementById('participantList');
            const count = document.getElementById('participantCount');
            
            // Handle undefined or null participants
            if (!participants || !Array.isArray(participants)) {
                count.textContent = '0';
                list.innerHTML = `<p class="text-gray-500 italic">${t('participants.none')}</p>`;
                return;
            }
            
            count.textContent = participants.length;
            list.innerHTML = participants.length === 0 
                ? `<p class=\"text-gray-500 italic\">${t('participants.none')}</p>`
                : participants.map(p => `
                    <div class="flex items-center justify-between bg-white p-3 rounded border border-gray-300">
                        <span class="font-bold text-gray-700">${p.username}</span>
                        ${isHost && currentRoom?.status === 'open' ? 
                            `<button onclick="removeParticipant('${p.username}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">Remove</button>` 
                            : ''}
                    </div>
                `).join('');
        }
        
        // Refresh Participants
        async function refreshParticipants() {
            if (!currentHostUsername || !currentHostPassword) return;
            
            try {
                const response = await fetch(`/api/rooms/${roomId}/host-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentHostUsername, password: currentHostPassword })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentRoom = data;
                    displayParticipants(data.participants, true);
                    renderBlacklist(data.blacklist || [], data.participants || [], false);
                    setBlacklistReadOnly(false);
                }
            } catch (error) {
                console.error('Error refreshing:', error);
            }
        }
        
        // Remove Participant
        async function removeParticipant(username) {
            try {
                const response = await fetch(`/api/rooms/${roomId}/remove-participant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hostUsername: currentHostUsername, hostPassword: currentHostPassword, username })
                });
                
                if (response.ok) {
                    await refreshParticipants();
                } else {
                    const data = await response.json();
                    showError(data.error);
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        // Start Room
        async function startRoom() {
            if (!currentRoom || currentRoom.participants.length < 2) {
                showError('You need at least 2 participants to start the room!');
                return;
            }
            
            const btn = event.target;
            try {
                setButtonState(btn, t('btn.startSecretSanta'), true);
                await refreshParticipants();
                
                const response = await fetch(`/api/rooms/${roomId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hostUsername: currentHostUsername, hostPassword: currentHostPassword })
                });
                
                if (response.ok) {
                    document.getElementById('startRoomSection').classList.add('hidden');
                    const msg = document.getElementById('roomStartedMessage');
                    msg.classList.remove('hidden');
                    msg.innerHTML = `<h3 class=\"font-bold text-green-800 mb-2\">${t('room.startedHostMsg')}</h3><p class=\"text-gray-700\">${t('room.startedHostDesc')}</p>`;
                } else {
                    const data = await response.json();
                    showError(data.error);
                    setButtonState(btn, t('btn.startSecretSanta'), false);
                }
            } catch (error) {
                showError(error.message);
                setButtonState(btn, t('btn.startSecretSanta'), false);
            }
        }
        
        // Registration Form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const preferences = document.getElementById('regPreferences').value.trim();
            const btn = e.target.querySelector('button');
            
            try {
                const data = await registerUser(roomId, username, password, btn);
                if (preferences && preferences.trim().length > 0) {
                    await fetch(`/api/rooms/${roomId}/preferences`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, preferences })
                    }).then(r => r.ok && (document.getElementById('regPrefsSaved').classList.remove('hidden')));
                }
                
                if (data.isHost) {
                    currentHostUsername = username;
                    currentHostPassword = password;
                    sessionStorage.setItem(`hostUser_${roomId}`, username);
                    sessionStorage.setItem(`hostPass_${roomId}`, password);
                    
                    const authResponse = await fetch(`/api/rooms/${roomId}/host-auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (authResponse.ok) {
                        currentRoom = await authResponse.json();
                        showHostManagementView(currentRoom);
                    }
                } else {
                    // Non-host participant - show participant view
                    // Check if registration response includes roomDetails
                    if (data.roomDetails) {
                        showParticipantView(data.roomDetails);
                    } else {
                        // Fallback: fetch room data
                        const roomResponse = await fetch(`/api/rooms/${roomId}`);
                        if (roomResponse.ok) {
                            const roomData = await roomResponse.json();
                            showParticipantView(roomData);
                        }
                    }
                }
            } catch (error) {
                showError(error.message);
            }
        });
        
        // Host Login Form
        document.getElementById('hostLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('hostUsername').value;
            const password = document.getElementById('hostPassword').value;
            
            try {
                const response = await fetch(`/api/rooms/${roomId}/host-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentHostUsername = username;
                    currentHostPassword = password;
                    currentRoom = data;
                    sessionStorage.setItem(`hostUser_${roomId}`, username);
                    sessionStorage.setItem(`hostPass_${roomId}`, password);
                    showHostManagementView(data);
                } else {
                    const data = await response.json();
                    showError(data.error);
                }
            } catch (error) {
                showError(error.message);
            }
        });
        
        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const btn = e.target.querySelector('button');
            
            try {
                const result = await loginAndDecrypt(roomId, username, password, btn);
                document.getElementById('loggedInUsername').textContent = result.username;
                const subtitleEl = document.getElementById('assignmentSubtitle');
                if (subtitleEl) {
                    subtitleEl.innerHTML = t('assignments.subtitle', { username: `<span id=\\"loggedInUsername\\">${result.username}</span>` });
                }
                document.getElementById('assignedPerson').textContent = result.assignment;
                const prefsEl = document.getElementById('recipientPreferences');
                if (prefsEl) {
                    const m = result.preferencesMap || {};
                    const val = m[result.assignment] || t('room.preferences.none');
                    prefsEl.textContent = val;
                }
                showView('assignmentView');
            } catch (error) {
                showError(error.message);
            }
        });
        
        // Initialize
        loadRoom();

        function populateInviteLink() {
            const el = document.getElementById('roomInviteUrl');
            if (el) {
                el.value = `${location.origin}/room/${roomId}`;
            }
        }

        function copyInviteLink() {
            const el = document.getElementById('roomInviteUrl');
            const btn = document.getElementById('copyInviteBtn');
            if (!el || !btn) return;
            navigator.clipboard.writeText(el.value).then(() => {
                const original = btn.textContent;
                btn.textContent = t('copied');
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-blue-500');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('bg-green-500');
                    btn.classList.add('bg-blue-500');
                }, 2000);
            });
        }

        function rtbExec(id, cmd) {
            const el = document.getElementById(id);
            if (!el) return;
            el.focus();
            document.execCommand(cmd, false, null);
        }

        function insertImage(id) {
            const url = prompt('Image URL');
            if (!url) return;
            const el = document.getElementById(id);
            if (!el) return;
            el.focus();
            document.execCommand('insertImage', false, url);
        }

        function populateRoomInfo(data) {
            const ib = document.getElementById('infoBudget');
            const ii = document.getElementById('infoInstructions');
            if (ib) ib.textContent = (data.budget || t('room.info.none'));
            if (ii) ii.textContent = (data.instructions || t('room.info.none'));
        }

        function participantOptions(participants, selected) {
            const names = (participants || []).map(p => p.username);
            return names.map(n => `<option value="${n}" ${selected===n?'selected':''}>${n}</option>`).join('');
        }

        function displayNameFromRule(nameLower, participants) {
            const n = String(nameLower || '').toLowerCase();
            const match = (participants || []).find(p => String(p.username||'').toLowerCase() === n);
            return match ? match.username : nameLower;
        }

        function addBlacklistRow(from = '', to = '') {
            const c = document.getElementById('blacklistContainer');
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            const parts = currentRoom?.participants || [];
            row.innerHTML = `
                <select class="input-christmas">${participantOptions(parts, from)}</select>
                <span class="px-1 text-gray-500">â†’</span>
                <select class="input-christmas">${participantOptions(parts, to)}</select>
                <button type="button" class="px-3 py-2 bg-red-500 text-white rounded" onclick="this.parentElement.remove()">âœ–</button>
            `;
            c.appendChild(row);
        }

        function renderBlacklist(rules, participants, readOnly = false) {
            const c = document.getElementById('blacklistContainer');
            const panel = document.getElementById('blacklistPanel');
            if (!c) return;
            c.innerHTML = '';
            if (!Array.isArray(rules)) rules = [];
            if (readOnly) {
                if (rules.length === 0) {
                    // Hide panel if nothing to show for standard users
                    if (panel) panel.classList.add('hidden');
                } else {
                    if (panel) panel.classList.remove('hidden');
                    rules.forEach(r => {
                        const row = document.createElement('div');
                        row.className = 'flex gap-2 items-center';
                        const fromName = displayNameFromRule(r.from, participants);
                        const toName = displayNameFromRule(r.to, participants);
                        row.innerHTML = `<span class="font-semibold">${fromName}</span><span class="text-gray-500">â†’</span><span class="font-semibold">${toName}</span>`;
                        c.appendChild(row);
                    });
                }
            } else {
                if (rules.length === 0) {
                    addBlacklistRow();
                } else {
                    rules.forEach(r => addBlacklistRow(r.from, r.to));
                }
            }
        }

        function setBlacklistReadOnly(readOnly) {
            const actions = document.getElementById('blacklistActions');
            if (actions) actions.classList.toggle('hidden', !!readOnly);
            const help = document.getElementById('blacklistHelp');
            if (help) help.classList.toggle('hidden', !!readOnly);
        }

        function collectBlacklist() {
            const c = document.getElementById('blacklistContainer');
            if (!c) return [];
            const rows = Array.from(c.children);
            return rows.map(r => {
                const selects = r.querySelectorAll('select');
                return { from: selects[0]?.value || '', to: selects[1]?.value || '' };
            }).filter(p => (p.from || '').trim() && (p.to || '').trim());
        }

        async function saveBlacklist() {
            try {
                const rules = collectBlacklist();
                const res = await fetch(`/api/rooms/${roomId}/blacklist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hostUsername: currentHostUsername, hostPassword: currentHostPassword, blacklist: rules })
                });
                if (res.ok) {
                    document.getElementById('blacklistSaved').classList.remove('hidden');
                    setTimeout(() => document.getElementById('blacklistSaved').classList.add('hidden'), 2000);
                } else {
                    const data = await res.json();
                    showError(data.error || 'Failed to save blacklist');
                }
            } catch (e) {
                showError(e.message);
            }
        }
    </script>
</body>
</html>
